---
category:
  - Knowledge
tags:
  - GCP
status: Done
---
### **1. 引言：认证 (Authentication) 与授权 (Authorization)**

在讨论 GCP 的“授权方式”时，我们首先要区分两个核心概念：

- **认证 (Authentication):** 验证“你是谁”的过程。这涉及到提供凭证（如密码、密钥、令牌）来证明你的身份。
- **授权 (Authorization):** 在你成功认证后，确定“你能做什么”的过程。这在 GCP 中主要由 **IAM (Identity and Access Management)** 通过分配**角色 (Roles)** 来实现，角色包含了具体的**权限 (Permissions)**。

本笔记主要关注 GCP 支持的**认证机制**，即证明身份的不同方法。

### **2. 人类用户认证**

主要指开发者、管理员等真人用户如何访问 GCP 资源，特别是控制台和 `gcloud` 命令行工具。

- **方式：Google 账号凭证 (用户名/密码 + 多因素认证)**
    - **描述:** 使用标准的 Google 账户（如 `@gmail.com` 或 Google Workspace/Cloud Identity 提供的 `@yourdomain.com` 账户）及其密码进行登录。强烈建议并通常强制启用两步验证 (2FA/MFA) 以增强安全性。
    - **应用场景:**
        - 登录 Google Cloud Console 网页界面。
        - 通过 `gcloud auth login` 命令初始化 `gcloud` CLI 工具时，会触发浏览器进行此认证流程。
    - **底层机制:** 认证成功后，后台通过 OAuth 2.0 协议流程获取用于访问 GCP API 的临时凭证（访问令牌）。

### **3. 应用/服务认证 (非人类身份)**

指虚拟机、容器、应用程序代码、CI/CD 工具等非人类实体访问 GCP API 的方式。核心身份是**服务账号 (Service Account)**。

- **身份类型：服务账号 (Service Account)**
    
    - **描述:** GCP 中代表应用或计算工作负载的特殊非人类身份。
- **认证机制 (服务账号如何证明其身份):**
    
    - **方式 1：服务账号密钥 (Service Account Keys)**
        - **描述:** 用户可以为服务账号生成并下载私钥文件（通常为 JSON 格式）。应用程序加载此密钥文件，使用其中的私钥信息生成签名或断言，通过 OAuth 2.0 流程换取访问令牌，从而以服务账号的身份调用 GCP API。
        - **应用场景:**
            - 在 GCP 外部运行的应用（如本地开发环境、其他云平台、本地服务器）。
            - 需要长期凭证的脚本或工具。
        - **优缺点:** 灵活；但密钥需要用户**自行安全地存储、分发和轮换**，存在泄露风险，管理负担较重。**应尽可能避免使用，优先考虑其他方式。**
    - **方式 2：GCP 元数据服务器 (Metadata Server)**
        - **描述:** 当代码运行在特定的 GCP 计算环境（如 Compute Engine VM, GKE Node/Pod, Cloud Functions, Cloud Run, App Engine）中时，该环境会提供一个本地可访问的元数据服务器 (通常是 `http://metadata.google.internal/...`)。代码**无需任何密钥文件**，只需向此服务器发出请求，即可获取与其所运行资源关联的服务账号的临时访问令牌。
        - **应用场景:** **所有运行在支持的 GCP 计算环境内的应用。**
        - **优缺点:** **强烈推荐！** 无需管理密钥，安全性高，凭证自动轮换，使用便捷。
    - **方式 3：工作负载身份联合 (Workload Identity Federation)**
        - **描述:** 允许运行在 GCP 外部（如 AWS、Azure、本地数据中心，或支持 OIDC/SAML 2.0 的身份提供商）的工作负载，使用其**本地环境的身份凭证**（例如 AWS IAM 角色、OIDC Token）来**模拟 (impersonate)** 一个 GCP 服务账号，获取临时的 GCP 访问令牌。
        - **应用场景:** **所有运行在 GCP 外部且需要访问 GCP 资源的应用。**
        - **优缺点:** **强烈推荐！** 同样无需管理 GCP 服务账号密钥，利用了外部环境已有的身份体系，安全性高。

### **4. API 密钥 (API Keys)**

- **方式:** 与 GCP 项目关联的一个简单的加密字符串。
- **描述:** API 密钥**不代表**特定的用户或服务账号身份。它主要用于**识别发起调用的 GCP 项目**，通常用于那些无需用户或服务账号授权即可访问的、公开性较强的 Google API（例如部分 Google Maps Platform API、某些公共数据集 API）。
- **应用场景:** 调用特定的、允许使用 API 密钥进行项目识别和配额管理的 GCP API 或 Google API。
- **局限性:** **不能用于**需要精细 IAM 授权的 GCP 服务（如管理 VM、存储桶等）。主要作用是项目识别、配额控制和简单的访问限制（如按 IP、HTTP 来源限制）。它与服务账号密钥是完全不同的概念和用途。

### **5. 底层协议：OAuth 2.0**

- **描述:** OAuth 2.0 是一个行业标准的**授权框架**。在 GCP 的多种认证流程中（包括用户通过 Google 账号登录、服务账号使用密钥或元数据服务器获取令牌），它都扮演着核心角色，用于安全地委托权限和交换凭证以获取临时的**访问令牌 (Access Token)**。最终对 GCP API 的调用通常都需要携带有效的 Access Token。用户通常不直接与 OAuth 2.0 协议交互，而是通过客户端库或工具自动完成。

### **6. 总结与建议**

- GCP 提供了针对不同身份（人类用户、应用/服务）和不同运行环境（GCP 内部、外部）的多种认证机制。
- 认证（证明你是谁）之后，由 IAM 角色和权限进行授权（决定你能做什么）。
- **最佳实践:**
    - 对人类用户，使用 Google 账号结合 MFA。
    - 对**在 GCP 内部运行**的应用/服务，**优先使用元数据服务器**获取凭证。
    - 对**在 GCP 外部运行**的应用/服务，**优先使用工作负载身份联合**。
    - **尽量避免**创建和下载服务账号密钥，若必须使用，务必安全管理和定期轮换。
    - 理解 API 密钥的**局限性**，仅在适用的 API 上用于项目识别和配额管理。

