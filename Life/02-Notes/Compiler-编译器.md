---
category:
- Tech
tags:
- Compiler
status: Done
---




# 1.ä¼ ç»Ÿç¼–è¯‘å™¨è®¾è®¡

## 1.1 ä¼ ç»Ÿç¼–è¯‘å™¨è®¾è®¡

![image-3.png](iOS-ç¼–è¯‘å™¨-ä¼ ç»Ÿç¼–è¯‘å™¨.png)

- **ç¼–è¯‘å™¨å‰ç«¯ï¼š**ç¼–è¯‘å™¨å‰ç«¯çš„ä»»åŠ¡æ˜¯**è§£ææºä»£ç **ã€‚å®ƒä¼šè¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦å­˜åœ¨é”™è¯¯ï¼Œç„¶åæ„å»º**æŠ½è±¡è¯­æ³•æ ‘**ï¼ˆAbstract Syntax Tree ï¼Œç¼©å†™ä¸º **AST**ï¼‰ï¼Œç„¶åæˆæˆ**ä¸­é—´ä»£ç ï¼ˆ** Intermediate Representation,ç¼©å†™ä¸º**IRï¼‰ã€‚**

- **ä¼˜åŒ–å™¨ï¼š**ä¼˜åŒ–å™¨è´Ÿè´£å„ç§ä¼˜åŒ–ï¼Œ**ç¼©å°åŒ…çš„ä½“ç§¯**ï¼ˆå‰¥ç¦»ç¬¦å· **ï¼‰** ã€**æ”¹å–„ä»£ç çš„è¿è¡Œæ—¶é—´ï¼ˆ** æ¶ˆé™¤å†—ä½™è®¡ç®—ã€å‡å°‘æŒ‡é’ˆè·³è½¬æ¬¡æ•°ç­‰ï¼‰ã€‚

- **åç«¯ã€ä»£ç ç”Ÿæˆå™¨ï¼š**åç«¯å°†ä»£ç æ˜ å°„åˆ°ç›®æ ‡æŒ‡ä»¤é›†ï¼Œç”Ÿæˆ**æœºå™¨è¯­è¨€**ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ã€‚

ç”±äºä¼ ç»Ÿçš„ç¼–è¯‘å™¨(å¦‚GCC) æ˜¯ä¸º**æ•´ä½“çš„åº”ç”¨ç¨‹åºè®¾è®¡**çš„ï¼Œ**ä¸æ”¯æŒå¤šç§è¯­è¨€**æˆ–è€…**å¤šç§ç¡¬ä»¶æ¶æ„**ï¼Œæ‰€ä»¥ä»–ä»¬çš„ç”¨é€”æ”¶åˆ°äº†å¾ˆå¤§çš„é™åˆ¶ã€‚

## 1.2 GCC

GNU ç¼–è¯‘å™¨é›†åˆï¼ˆGCCï¼‰æ˜¯GNUé¡¹ç›®äº§ç”Ÿçš„ä¼˜åŒ–ç¼–è¯‘å™¨ï¼Œæ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€ã€ç¡¬ä»¶ä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿã€‚GCC æ˜¯GNU å·¥å…·é“¾çš„å…³é”®ç»„ä»¶ï¼Œä¹Ÿæ˜¯å¤§å¤šæ•°ä¸GNUå’ŒLinux å†…æ ¸ç›¸å…³çš„é¡¹ç›®çš„æ ‡å‡†ç¼–è¯‘å™¨ã€‚

GCC åŸåä¸º GNU C è¯­è¨€ç¼–è¯‘å™¨ï¼Œå› ä¸ºå®ƒåŸæœ¬åªèƒ½å¤„ç† Cè¯­è¨€ã€‚GCC å¾ˆå¿«åœ°æ‰©å±•ï¼Œå˜å¾—å¯å¤„ç† C++ã€‚ä¹‹åä¹Ÿå˜å¾—å¯å¤„ç† Fortranã€Pascalã€Objective-Cã€Java, ä»¥åŠ Adaä¸å…¶ä»–è¯­è¨€ã€‚

# 2.LLVMçš„è®¾è®¡

## 2.1 LLVM

**LLVM** æ˜¯ç¼–è¯‘å™¨çš„æ¶æ„ç³»ç»Ÿï¼Œ**C++** ç¼–å†™è€Œæˆçš„ã€‚ç”¨äºä¼˜åŒ–ä»¥ä»»æ„è¯­è¨€ç¼–å†™çš„ç¨‹åºçš„**ç¼–è¯‘æ—¶é—´(compile-time)ã€è¿æ¥æ—¶é—´(link-time)ã€è¿è¡Œæ—¶é—´(run-time)ã€ç©ºé—²æ—¶é—´ (idle-time)**ã€‚

**LLVM**è®¾è®¡ä¸­æœ€é‡è¦çš„è®¾è®¡æ˜¯ä½¿ç”¨äº†é€šç”¨çš„ä»£ç è¡¨ç¤ºå½¢å¼(**IR)ï¼Œ** åœ¨éœ€è¦æ”¯æŒä¸€ç§**æ–°çš„è¯­è¨€**æ—¶ **ï¼Œ** åªéœ€è¦å†ç¼–å†™ä¸€ä¸ªå¯ä»¥**äº§ç”ŸIRçš„** **ç‹¬ç«‹** **å‰ç«¯ï¼›** éœ€è¦æ”¯æŒä¸€ç§**æ–°çš„ç¡¬ä»¶æ¶æ„**æ—¶ **ï¼Œ**åªéœ€è¦å†ç¼–å†™ä¸€ä¸ª**å¯ä»¥æ¥æ”¶IRçš„** **ç‹¬ç«‹åç«¯** **ã€‚**

![image-4.png](../assets/iOS-ç¼–è¯‘å™¨-LLVM.png)

## 2.2 LLVMç»„ä»¶

LLVMç»„ä»¶å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

- **å‰ç«¯ï¼ˆFrontendï¼‰**ï¼šè´Ÿè´£å°†æºä»£ç ç¼–è¯‘æˆ LLVM ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ã€‚LLVM æä¾›äº†ç”¨äºç¼–è¯‘ Cã€C++ã€Objective-Cã€Objective-C++ã€Rustã€Swiftã€Go ç­‰è¯­è¨€çš„å‰ç«¯ã€‚
- **ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰**ï¼šè´Ÿè´£å¯¹ LLVM IR è¿›è¡Œä¼˜åŒ–ï¼Œä»¥æé«˜ç¨‹åºçš„æ€§èƒ½å’Œå¯ç§»æ¤æ€§ã€‚LLVM æä¾›äº†ä¸€ä¸ªåºå¤§çš„ä¼˜åŒ–å™¨æµæ°´çº¿ï¼ŒåŒ…å«äº†è®¸å¤šä¸åŒçš„ä¼˜åŒ– passã€‚
- **åç«¯ï¼ˆBackendï¼‰**ï¼šè´Ÿè´£å°† LLVM IR è½¬æ¢ä¸ºç›®æ ‡æœºå™¨ä»£ç ã€‚LLVM æä¾›äº†ç”¨äºç”Ÿæˆ x86ã€x86-64ã€ARMã€AArch64ã€PowerPCã€RISC-V ç­‰å¹³å°çš„åç«¯ã€‚
- **å·¥å…·ï¼ˆToolsï¼‰**ï¼šæä¾›ç”¨äºå¤„ç† LLVM æ–‡ä»¶å’Œ IR çš„å·¥å…·ã€‚LLVM æä¾›äº†æ±‡ç¼–å™¨ã€åæ±‡ç¼–å™¨ã€è°ƒè¯•å™¨ã€ç¬¦å·è¡¨åˆ†æå™¨ç­‰å·¥å…·ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„ LLVM ç»„ä»¶ï¼š

1. **Clang**: Clang æ˜¯ LLVM çš„å‰ç«¯ç¼–è¯‘å™¨ï¼Œå®ƒç”¨äºå°†æºä»£ç ç¿»è¯‘æˆä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ä»¥ä¾¿åç»­ç¼–è¯‘å’Œä¼˜åŒ–ã€‚Clang æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚Cã€C++ã€Objective-C å’ŒObjective-C++ã€‚

2. **LLVM IR**: LLVM ä¸­é—´è¡¨ç¤ºæ˜¯ä¸€ç§ç±»ä¼¼æ±‡ç¼–è¯­è¨€çš„ä¸­é—´è¯­è¨€ï¼Œç”¨äºè¡¨ç¤ºç¼–è¯‘åçš„ç¨‹åºã€‚LLVM IR æ˜¯é™æ€å•èµ‹å€¼ï¼ˆSSAï¼‰å½¢å¼ï¼Œè¿™ä½¿å¾—è¿›è¡Œé«˜æ•ˆçš„ç¼–è¯‘ä¼˜åŒ–æˆä¸ºå¯èƒ½ã€‚

3. **LLVM Core Libraries**: LLVM åŒ…æ‹¬ä¸€ç³»åˆ—æ ¸å¿ƒåº“ï¼Œç”¨äºå¤„ç†å’Œæ“ä½œ LLVM IRï¼Œä»¥åŠæ‰§è¡Œå„ç§ç¼–è¯‘å™¨ä»»åŠ¡ï¼Œå¦‚è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€ä»£ç ç”Ÿæˆç­‰ã€‚

4. **LLVM Backend**: LLVM æ”¯æŒå¤šç§ç›®æ ‡æ¶æ„ï¼Œå› æ­¤å®ƒæœ‰ä¸åŒçš„åç«¯ï¼Œç”¨äºå°† LLVM IR è½¬æ¢ä¸ºç‰¹å®šç›®æ ‡æ¶æ„çš„æœ¬åœ°æœºå™¨ä»£ç ã€‚è¿™äº›åç«¯åŒ…æ‹¬X86ã€ARMã€PowerPCç­‰ã€‚

5. **Optimization Passes**: LLVM æä¾›äº†å¤šç§ç¼–è¯‘ä¼˜åŒ–ä¼ é€’ï¼Œç”¨äºæé«˜ç”Ÿæˆçš„æœºå™¨ä»£ç çš„æ€§èƒ½ã€‚è¿™äº›ä¼ é€’åŒ…æ‹¬å¸¸è§çš„ä¼ é€’ï¼Œå¦‚æ­»ä»£ç æ¶ˆé™¤ã€å†…è”å‡½æ•°ã€å¾ªç¯ä¼˜åŒ–ç­‰ã€‚

6. **LLD (LLVM Linker)**: LLD æ˜¯ LLVM çš„é“¾æ¥å™¨ï¼Œç”¨äºå°†ç”Ÿæˆçš„ç›®æ ‡ä»£ç æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚LLD æ”¯æŒå¤šç§ä¸åŒæ ¼å¼çš„ç›®æ ‡æ–‡ä»¶ï¼Œå¦‚ELFã€COFFã€Mach-Oç­‰ã€‚
   1. **LLDB (LLVM Debugger)**: LLDB æ˜¯ LLVM çš„è°ƒè¯•å™¨ï¼Œç”¨äºè°ƒè¯•ç”Ÿæˆçš„ç¨‹åºï¼Œå¹¿æ³›ä½¿ç”¨ LLVM çš„ç°æœ‰åº“ï¼Œä¾‹å¦‚Clangè¡¨è¾¾å¼è§£æå™¨å’Œ LLVMåæ±‡ç¼–å™¨ã€‚å®ƒå¯ä»¥ä¸å¤šç§ç¼–ç¨‹è¯­è¨€å’Œå¹³å°ä¸€èµ·ä½¿ç”¨ã€‚

7. **CMake**: LLVM ä½¿ç”¨CMakeä½œä¸ºæ„å»ºç³»ç»Ÿï¼Œç”¨äºè·¨å¹³å°çš„æ„å»ºå’Œå®‰è£…ã€‚

8. **TableGen**: TableGen æ˜¯ LLVM ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºç”Ÿæˆå„ç§ä»£ç å’Œæ•°æ®è¡¨ï¼ŒåŒ…æ‹¬ç›®æ ‡æè¿°ã€æŒ‡ä»¤æè¿°ç­‰ã€‚

9. **Clang Static Analyzer**: Clang Static Analyzer æ˜¯ç”¨äºåˆ†ææºä»£ç ä»¥æŸ¥æ‰¾æ½œåœ¨çš„ç¼ºé™·å’Œé”™è¯¯çš„å·¥å…·ï¼Œå¦‚å†…å­˜æ³„æ¼ã€ç©ºæŒ‡é’ˆè§£å¼•ç”¨ç­‰ã€‚

# 3.Clang

Clangæ˜¯LLVMç¼–è¯‘å™¨å·¥å…·é›†çš„å‰ç«¯ï¼Œç”± Apple ä¸»åŠ¨ç¼–å†™ï¼Œæ˜¯LLVMé¡¹ç›®ä¸­çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚åŸºäº LLVM çš„è½»é‡çº§ç¼–è¯‘å™¨ï¼Œä¹‹åˆæ˜¯ä¸ºäº†æ›¿ä»£GCCï¼ˆGCCä¹Ÿå¯ä»¥ä½œä¸ºLLVMçš„å‰ç«¯ï¼‰ï¼Œæä¾›æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚ä»–æ˜¯è´Ÿè´£ç¼–è¯‘Cã€C++ã€Objective-Cã€CUDAã€OpenCL...çš„ç¼–è¯‘å™¨ ã€‚

> iOSåœ¨XCodeç¼–è¯‘ä»£ç ç è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šé‡åˆ°clang: error: linker command failed with exit code 1 (use -v to see invocation) é”™è¯¯ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚

## 3.1 ç¼–è¯‘æµç¨‹

å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ‰“å°æºç çš„ç¼–è¯‘è¿‡ç¨‹ï¼š

```
clang -ccc-print-phases main.m
```

æ‰“å°ç»“æœå¦‚ä¸‹ï¼š

![image-5.png](../assets/iOS-ç¼–è¯‘å™¨-ç¼–è¯‘æµç¨‹.png)

**æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æ˜ç¡®æŒ‡å‡ºä¼˜åŒ–å™¨ï¼Œæ˜¯å› ä¸ºä¼˜åŒ–å·²ç»åˆ†å¸ƒåœ¨å‰åç«¯é‡Œé¢äº†ã€‚**

![image-5.png](../assets/iOS-ç¼–è¯‘å™¨-ç¼–è¯‘æµç¨‹-1.png)

æ¥ä¸‹æ¥å¯¹æ¯ä¸ªæ­¥éª¤ï¼Œè¯¦ç»†åˆ†æï¼š

### 0ï¼šè¾“å…¥æºæ–‡ä»¶ï¼š

æ‰¾åˆ°æºæ–‡ä»¶

### 1ï¼šé¢„å¤„ç†é˜¶æ®µï¼š

æ‰§è¡Œé¢„å¤„ç†æŒ‡ä»¤ï¼ŒåŒ…æ‹¬è¿›è¡Œå®æ›¿æ¢ã€å¤´æ–‡ä»¶çš„å¯¼å…¥ã€æ¡ä»¶ç¼–è¯‘ï¼Œäº§ç”Ÿæ–°çš„æºç ç»™åˆ°ç¼–è¯‘å™¨.å¯ä»¥é€šè¿‡å‘½ä»¤`clang -E main.m`ï¼Œçœ‹åˆ°æ‰§è¡Œé¢„å¤„ç†æŒ‡ä»¤åçš„ä»£ç ã€‚

### 2ï¼šç¼–è¯‘é˜¶æ®µ->ç”ŸæˆIR(.ll) æˆ–è€… bitcode(.bc)æ–‡ä»¶

**è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€æ£€æµ‹è¯­æ³•æ˜¯å¦æ­£ç¡®ã€ç”ŸæˆASTã€ç”ŸæˆIR(.ll) æˆ–è€… bitcode(.bc)æ–‡ä»¶ï¼š**

#### 2.1 è¯æ³•åˆ†æ: 

é¢„å¤„ç†å®Œæˆåï¼Œè¿›è¡Œ**è¯æ³•åˆ†æ**ï¼Œå°†ä»£ç åˆ†éš”æˆä¸€ä¸ªä¸ªçš„**Token**åŠæ ‡æ˜å…¶æ‰€åœ¨çš„**è¡Œæ•°å’Œåˆ—æ•°**ï¼ŒåŒ…æ‹¬å…³é”®å­—ã€ç±»åã€æ–¹æ³•åã€å˜é‡åã€æ‹¬å·ã€è¿ç®—ç¬¦ç­‰

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°è¯æ³•åˆ†æåçš„ç»“æœï¼š

```
clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m
```

![image-7.png](../assets/iOS-ç¼–è¯‘å™¨-è¯æ³•åˆ†æ.png)

#### 2.2 è¯­æ³•åˆ†æ

è¯æ³•åˆ†æåï¼Œæ˜¯**è¯­æ³•åˆ†æ**ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯**éªŒè¯æºç¨‹åºçš„è¯­æ³•ç»“æ„çš„æ­£ç¡®æ€§**ï¼Œåœ¨è¯æ³•åˆ†æçš„åŸºç¡€ä¸Šï¼Œå°†å•è¯ç»„åˆæˆå„ç±»è¯­æ³•çŸ­è¯­ï¼Œå¦‚è¯­å¥ã€è¡¨è¾¾å¼ç­‰ã€‚ç„¶åå°†æ‰€æœ‰èŠ‚ç‚¹ç»„æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆ**AST**ï¼‰ã€‚

é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹è¯­æ³•åˆ†æåçš„ç»“æœï¼š

```
clang -fmodules -fsyntax-only -Xclang -ast-dump main.m

// å¦‚æœå¯¼å…¥å¤´æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œå¯ä»¥æŒ‡å®šSDK
clang -isysroot sdkè·¯å¾„ -fmodules -fsyntax-only -Xclang -ast-dump main.m
```

![image-8.png](../assets/iOS-ç¼–è¯‘å™¨-è¯­æ³•åˆ†æ.png)

#### 2.3 ç”ŸæˆIR

å°†**è¯­æ³•æ ‘**è‡ªé¡¶å‘ä¸‹éå†é€æ­¥**ç¿»è¯‘æˆLLVM IR**ã€‚OC ä»£ç åœ¨è¿™ä¸€æ­¥ä¼šè¿›è¡Œ**è¿è¡Œæ—¶**çš„å¤„ç†ï¼Œæ¯”å¦‚ **åˆ†ç±»å±æ€§çš„åˆæˆã€ARCå¤„ç†ç­‰**

é€šè¿‡ä¸‹é¢çš„å‘½ä»¤å¯ä»¥ç”Ÿæˆ **.ll** **çš„æ–‡æœ¬æ–‡ä»¶**ï¼ŒæŸ¥çœ‹**IRä»£ç ï¼š**

```
clang -S -fobjc-arc -emit-llvm main.m
```

![image-9.png](../assets/iOS-ç¼–è¯‘å™¨-ç”ŸæˆIR.png)

**ä¸Šé¢IRä»£ç çš„æ„æ€æ˜¯**ï¼š

1. test æ–¹æ³•ï¼Œè¾“å…¥ä¸¤ä¸ªå‚æ•° %0ï¼Œ %1
2. åˆ›å»ºä¸¤ä¸ªå˜é‡ %3ï¼Œ%4

1. å°†%0çš„æ•°æ®å†™å…¥åˆ°%3ä¸­ï¼Œå°†%1çš„æ•°æ®å†™å…¥åˆ°%4ä¸­
2. è¯»å–%3çš„æ•°æ®å¹¶èµ‹å€¼ç»™%5ï¼Œè¯»å–%4çš„æ•°æ®å¹¶èµ‹å€¼ç»™%6

1. å°†%5 åŠ ä¸Š %6çš„ç»“æœèµ‹å€¼ç»™%7
2. å°†%7 åŠ ä¸Š 3 çš„ç»“æœèµ‹å€¼ç»™%8

1. è¿”å›%8

#### IR ä¼˜åŒ–

åœ¨ä¸Šé¢çš„IRä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä¸€ç‚¹ä¸€ç‚¹ç¿»è¯‘è¯­æ³•æ ‘ï¼Œç”Ÿæˆçš„IRä»£ç ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹è ¢ï¼Œå…¶å®æ˜¯å¯ä»¥ä¼˜åŒ–çš„ã€‚

**IRä¼˜åŒ–ç­‰çº§ä»ä½åˆ°é«˜åˆ†åˆ«æ˜¯ï¼š** **-O0 -O1 -O2 -O3 -Os -Ofast -Oz**

å¯ä»¥ä½¿ç”¨**å‘½ä»¤**è¿›è¡Œ**ä¼˜åŒ–**:

```
clang -Os -S -fobjc-arc -emit-llvm main.m -o main.ll
```

ä¹Ÿå¯ä»¥åœ¨ **xcode** ä¸­**è®¾ç½®**ï¼štarget -> build Setting -> **Optimization Level**

![iOS-ç¼–è¯‘å™¨-Xcodeè®¾ç½®ä¼˜åŒ–çº§åˆ«](../assets/iOS-ç¼–è¯‘å™¨-Xcodeè®¾ç½®ä¼˜åŒ–çº§åˆ«.png)

æˆ‘ä»¬çœ‹ä¸€ä¸‹**Osçº§åˆ«**ä¼˜åŒ–åçš„ä»£ç ï¼š

![image-11.png](../assets/iOS-ç¼–è¯‘å™¨-IRä¼˜åŒ–å.png)

**ä¸Šé¢IRä»£ç çš„æ„æ€æ˜¯**ï¼š

1. å°†%0 åŠ ä¸Š 3 ç»“æœèµ‹å€¼ç»™%3
2. å°†%3åŠ ä¸Š%1çš„ç»“æœèµ‹å€¼ç»™%4

1. è¿”å›%4

**ä¼˜åŒ–åçš„IRä»£ç ï¼Œæ›´åŠ çš„ç®€æ´æ˜äº†äº†ï¼**

#### bitcode

xcode7ä¹‹åï¼Œå¦‚æœå¼€å¯äº†bitcode, è‹¹æœä¼š**å¯¹IRæ–‡ä»¶**åšè¿›ä¸€æ­¥çš„**ä¼˜åŒ–** **ç”Ÿæˆ.bc æ–‡ä»¶**çš„ä¸­é—´ä»£ç ã€‚

å‘½ä»¤å¦‚ä¸‹ï¼š

```
clang -emit-llvm -c main.ll -o main.bc
```

### 3ï¼šåç«¯é˜¶æ®µ->æ±‡ç¼–æ–‡ä»¶(.s)ï¼š

åç«¯å°†æ¥æ”¶åˆ°çš„ IR ç»“æ„åŒ–æˆä¸åŒçš„å¤„ç†å¯¹è±¡ï¼Œå¹¶å°†å…¶å¤„ç†è¿‡ç¨‹å®ç°ä¸ºä¸€ä¸ªä¸ªçš„Passç±»å‹ã€‚é€šè¿‡å¤„ç† Pass ï¼Œæ¥å®Œæˆå¯¹IRçš„è½¬æ¢ã€åˆ†æå’Œä¼˜åŒ–ã€‚ç„¶åç”Ÿæˆæ±‡ç¼–ä»£ç ã€‚

å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
// bitcode -> .s  
clang -S -fobjc-arc main.bc -o main.s
// IR -> .s  
clang -S -fobjc-arc main.ll -o main.s
// ä¹Ÿå¯ä»¥å¯¹æ±‡ç¼–ä»£ç è¿›è¡Œä¼˜åŒ–
clang -Os -S -fobjc-arc main.ll -o main.s
```

![image-12.png](../assets/iOS-ç¼–è¯‘å™¨-ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶.png)

### 4ï¼šæ±‡ç¼–é˜¶æ®µ->ç”Ÿæˆç›®æ ‡æ–‡ä»¶(.o)ï¼š

æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢æˆæœºå™¨ç ï¼Œç”Ÿæˆä¸€ä¸ªä¸ªçš„ç›®æ ‡æ–‡ä»¶çš„Mach-Oæ–‡ä»¶

å‘½ä»¤å¦‚ä¸‹ï¼š

```
clang -fmodules -c main.s -o main.o
```

é€šè¿‡ nm çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹main.oçš„mach-Oæ–‡ä»¶çš„ç¬¦å·

```
xcrun nm -nm main.o
```

æ‰“å°ç»“æœå¦‚ä¸‹ï¼š

![image-13.png](../assets/iOS-ç¼–è¯‘å™¨-ç”Ÿæˆç›®æ ‡æ–‡ä»¶.png)

å¯ä»¥çœ‹åˆ°æ‰§è¡Œå‘½ä»¤æ—¶ï¼ŒæŠ¥äº†ä¸€ä¸ªé”™ï¼š**æ²¡æ‰¾åˆ°å¤–éƒ¨çš„ _printf çš„ç¬¦å·ã€‚** å› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯åœ¨å¤–éƒ¨å¼•å…¥çš„ï¼Œè¿™é‡Œéœ€è¦æŠŠ**ä½¿ç”¨åˆ°çš„å…¶ä»–çš„åº“ä¹Ÿ** **é“¾æ¥è¿‡æ¥**ï¼Œæ‰èƒ½ä¸æŠ¥é”™ã€‚

### 5ï¼šé“¾æ¥é˜¶æ®µ->å¯æ‰§è¡Œçš„Mach-Oæ–‡ä»¶ï¼š

å°†ä¸€ä¸ªä¸ªçš„ç›®æ ‡æ–‡ä»¶é“¾æ¥åˆ°ä¸€èµ·ï¼Œå¹¶ä¸”**é“¾æ¥éœ€è¦çš„åŠ¨æ€åº“(.dylib)å’Œé™æ€åº“(.a)** ï¼Œç”Ÿæˆ**å¯æ‰§è¡Œæ–‡ä»¶ -ï¼ˆMach-Oï¼‰æ–‡ä»¶ã€‚**

å‘½ä»¤å¦‚ä¸‹ï¼š

```
clang main.o -o main
```

![image-14.png](../assets/iOS-ç¼–è¯‘å™¨-ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶.png)

å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœä¸­ä¾ç„¶æ˜¾ç¤ºæ²¡æœ‰æ‰¾åˆ°å¤–éƒ¨ç¬¦å· printf , ä½†æ˜¯åé¢å¤šäº†ï¼ˆfrom libsystemï¼‰ã€‚**æŒ‡æ˜_printf æ‰€åœ¨çš„åº“æ˜¯** **libsystemã€‚** è¿™æ˜¯å› ä¸º**libsystemåŠ¨æ€åº“ï¼Œ** éœ€è¦åœ¨**è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š** **ã€‚** ç›®å‰è¿™ä¸ªæ–‡ä»¶å·²ç»æ˜¯ä¸€ä¸ª**æ­£ç¡®çš„å¯æ‰§è¡Œæ–‡ä»¶**äº†ã€‚

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰§è¡Œï¼š

```
./main
```

æ‰§è¡Œç»“æœï¼š

![image-15.png](../assets/iOS-ç¼–è¯‘å™¨-æ‰§è¡Œç»“æœ.png)

### 6ï¼šç»‘å®šç¡¬ä»¶æ¶æ„ï¼š

**æ ¹æ®x86_64ç¡¬ä»¶æ¶æ„ç”Ÿæˆå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶** **ï¼ˆMach-Oï¼‰**

## 3.2 æ€»ç»“ç¼–è¯‘æµç¨‹

### 1. å„é˜¶æ®µä½¿ç”¨çš„å‘½ä»¤

```
//// ====== å‰ç«¯ å¼€å§‹=====
// 1. è¯æ³•åˆ†æ
clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m

// 2. è¯­æ³•åˆ†æ
clang -fmodules -fsyntax-only -Xclang -ast-dump main.m

// 3. ç”ŸæˆIRæ–‡ä»¶
clang -S -fobjc-arc -emit-llvm main.m

// 3.1 æŒ‡å®šä¼˜åŒ–çº§åˆ«ç”ŸæˆIRæ–‡ä»¶
clang -Os -S -fobjc-arc -emit-llvm main.m -o main.ll

// 3.2 ï¼ˆæ ¹æ®ç¼–è¯‘å™¨è®¾ç½®ï¼‰ ç”Ÿæˆbitcode æ–‡ä»¶
clang -emit-llvm -c main.ll -o main.bc


//// ====== åç«¯ å¼€å§‹=====

// 1. ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶
// bitcode -> .s  
clang -S -fobjc-arc main.bc -o main.s
// IR -> .s  
clang -S -fobjc-arc main.ll -o main.s
// æŒ‡å®šä¼˜åŒ–çº§åˆ«ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶
clang -Os -S -fobjc-arc main.ll -o main.s


// 2. ç”Ÿæˆç›®æ ‡Mach-Oæ–‡ä»¶
clang -fmodules -c main.s -o main.o
// 2.1 æŸ¥çœ‹Mach-Oæ–‡ä»¶
xcrun nm -nm main.o

// 3. ç”Ÿæˆå¯æ‰§è¡ŒMach-Oæ–‡ä»¶
clang main.o -o main


//// ====== æ‰§è¡Œ å¼€å§‹=====
// 4. æ‰§è¡Œå¯æ‰§è¡ŒMach-Oæ–‡ä»¶
./main
```

### 2. å„ä¸ªé˜¶æ®µç”Ÿæˆçš„æ–‡ä»¶ç±»å‹

![image-16.png](../assets/iOS-ç¼–è¯‘å™¨-Clangå„æµç¨‹ç”Ÿæˆçš„æ–‡ä»¶.png)

### 3. ç¼–è¯‘æµç¨‹å›¾ç¤º

![image-17.png](../assets/iOS-ç¼–è¯‘å™¨-Clangæµç¨‹ç¤ºæ„å›¾.png)

## 3.3 OC ç”ŸæˆC++æ–‡ä»¶

- **åŠŸèƒ½ï¼š** å¯ä»¥æŠŠ `OC` æ–‡ä»¶ç¼–è¯‘æˆ `C++`æ–‡ä»¶ã€‚ ä¾‹å¦‚ `main.m` ç¼–è¯‘æˆ `main.cpp` æ–‡ä»¶ï¼Œç”¨æ¥æ›´å¥½çš„æŸ¥çœ‹ä»£ç çš„åº•å±‚ç»“æ„åŠå®ç°é€»è¾‘ï¼Œä¾¿äºäº†è§£åº•å±‚åŸç†ã€‚

- **ç¼–è¯‘æ–¹å¼ï¼š** åœ¨ç»ˆç«¯ä¸­è¿›å…¥éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œæ–‡ä»¶ç¼–è¯‘å‘½ä»¤ï¼š

  ```
  //1ã€å°† main.m ç¼–è¯‘æˆ main.cpp
  clang -rewrite-objc main.m -o main.cpp
  
  //2ã€å°† ViewController.m ç¼–è¯‘æˆ  ViewController.cpp
  clang -rewrite-objc -fobjc-arc -fobjc-runtime=ios-13.0.0 -isysroot / /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator13.7.sdk ViewController.m
  
  //ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ˜¯é€šè¿‡æŒ‡å®šæ¶æ„æ¨¡å¼çš„å‘½ä»¤è¡Œï¼Œä½¿ç”¨xcodeå·¥å…· xcrun
  //3ã€æ¨¡æ‹Ÿå™¨æ–‡ä»¶ç¼–è¯‘
  - xcrun -sdk iphonesimulator clang -arch arm64 -rewrite-objc main.m -o main-arm64.cpp 
  
  //4ã€çœŸæœºæ–‡ä»¶ç¼–è¯‘
  - xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main- arm64.cpp 
  ```

ä¸¾ä¸ªğŸŒ°ï¼š

```
- (instancetype)init {
    self = [super init];
    if (self) {
        NSLog(@"%@-----%@", [self class], [super class]);
    }
    return self;
}
```

ç¼–è¯‘åï¼š

```
static instancetype _I_LGPerson_init(LGPerson * self, SEL _cmd) {
    self = ((LGPerson *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super){(id)self, (id)class_getSuperclass(objc_getClass("LGPerson"))}, sel_registerName("init"));
    if (self) {
        NSLog((NSString *)&__NSConstantStringImpl__var_folders_86_0y_j3bzj65z6vw6hy1chw_4m0000gp_T_LGPerson_1615a9_mi_0, ((Class (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName("class")), ((Class (*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super){(id)self, (id)class_getSuperclass(objc_getClass("LGPerson"))}, sel_registerName("class")));
    }
    return self;
}
```

ä»¥ä¸Šå‚è€ƒ[iOSç¼–è¯‘åŸç†ç¯‡â€œLLVM & Clangâ€](https://juejin.cn/post/7041112216287838238)

# 4.Swiftc

**Swift** çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨ **Swiftc** ï¼Œä¸ **Clang** ä¸€æ ·ï¼Œ**Swiftc** æ˜¯**LLVM**ç¼–è¯‘æ¶æ„çš„ä¸€ä¸ª**å‰ç«¯ã€‚**

## 4.1 swift çš„ç¼–è¯‘æµç¨‹

![image.png](../assets/iOS-ç¼–è¯‘å™¨-Swiftæµç¨‹ç¤ºæ„å›¾.png)

**ä¸ Clang ç›¸æ¯”ï¼Œ LLVMå‰ç«¯çš„æµç¨‹ä¸­ï¼Œåœ¨AST å’Œ IRä¹‹é—´ï¼Œå¤šäº†ä¸€å±‚ä¸­é—´è¯­è¨€SIL** **(Swift Intermediate Language )** **ï¼Œ** è¿™ä¹ˆåšçš„ç›®çš„æ˜¯å¸Œæœ›å¼¥è¡¥ä¸€äº› Clang ç¼–è¯‘å™¨çš„ç¼ºé™·ï¼Œå¦‚æ— æ³•æ‰§è¡Œä¸€äº›**é«˜çº§åˆ†æï¼Œå¯é çš„è¯Šæ–­å’Œä¼˜åŒ–**ï¼Œè€Œ AST å’ŒLLVM IR éƒ½ä¸æ˜¯åˆé€‚çš„é€‰æ‹©ã€‚å› æ­¤ï¼ŒSILåº”è¿è€Œç”Ÿï¼Œç”¨æ¥è§£å†³ç°æœ‰çš„ç¼ºé™·ã€‚

ä»¥ä¸Šå‚è€ƒ[Swifté«˜çº§è¿›é˜¶-Swiftç¼–è¯‘è¿‡ç¨‹ï¼Œâ€SILä»£ç â€œï¼Œâ€œIRè¯­æ³•â€](https://juejin.cn/post/7041105468852273166)


# 5.Xcodeç¼–è¯‘å™¨çš„å˜åŒ–å†å²

1. GCCç¼–è¯‘å™¨æ—¶ä»£
2. LLVM-GCCç¼–è¯‘å™¨æ—¶ä»£
3. LLVM-Clangã€LLVM-Swiftcç¼–è¯‘å™¨æ—¶ä»£

