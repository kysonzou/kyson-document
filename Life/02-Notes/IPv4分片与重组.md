---
category:
  - Tech
tags:
  - TCPIP
status: Done
---
#### **1. 什么是分片**

**分片**（**Fragmentation**）是指当一个IP数据包的大小超过了在其传输路径上的某个网络链路的最大传输单元（**MTU**，**Maximum Transmission Unit**）时，将该数据包拆分成更小的片段，以确保它们能够顺利通过该链路的过程。在IP协议中，分片主要发生在**网络层**，即**IP层**。

#### **2. 为什么需要分片**

不同的网络链路具有不同的MTU。例如，以太网的标准MTU通常是1500字节，而某些广域网（如PPPoE）的MTU可能只有1492字节或更小。当一个IP数据包的大小超过当前链路的MTU时，为了确保数据包能够传输，必须进行分片。

#### **3. 分片的过程**
  
当一个IP数据包需要分片时，以下步骤会被执行：

1. **检测需要分片的数据包**：

    - 当发送方准备发送一个IP数据包时，网络层会检查数据包的大小是否超过当前链路的MTU。
    - 如果超过，数据包将被分片；否则，数据包直接发送。

2. **拆分数据包**：

    - **原始数据包**被拆分成多个较小的**片段**，每个片段的大小不超过MTU减去IP头部的大小（通常是20字节）。
    - 每个片段都包含一个完整的IP头部，但部分字段会有所调整，以便于在接收端重新组装。

3. **调整IP头部字段**：

    - **Identification（标识符）**：所有片段共享相同的标识符，用于标识它们属于同一个原始数据包。
    - **Flags（标志）**：
        - **第一个标志位（Reserved）**：通常为0。
        - **分片标志（DF，Don’t Fragment）**：指示是否允许分片。
        - **更多分片标志（MF，More Fragments）**：除了最后一个片段外，其他所有片段的MF标志都设置为1，表示后面还有更多片段。
    - **Fragment Offset（片偏移）**：指示当前片段在原始数据包中的位置，单位为8字节。这个字段帮助接收端正确地重组数据包。

4. **传输分片**：
    - 每个分片作为独立的IP数据包被发送到目的地，按照网络协议栈的正常传输流程进行转发。


> [!note]- 分片后的IP数据结构
> 每个分片的IP头部包含以下关键字段：
> 
> - **Version（版本）**：4（表示IPv4）。
> 
> - **IHL（头部长度）**：通常为5，表示20字节的IP头部。
> 
> - **Type of Service（服务类型）**：用于服务质量（QoS）等。
> 
> - **Total Length（总长度）**：当前片段的总长度，包括头部和数据。
> 
> - **Identification（标识符）**：相同的标识符用于标识同一个原始数据包的所有片段。
> 
> - **Flags（标志）**：
> 
>    - **DF（Don’t Fragment）**：指示是否允许分片。
> 
>    - **MF（More Fragments）**：指示是否有更多片段。
> 
> - **Fragment Offset（片偏移）**：当前片段在原始数据包中的位置。
> 
> - **TTL（生存时间）**：防止数据包在网络中无限循环。
> 
> - **Protocol（协议）**：指示上层使用的协议（如TCP、UDP）。
> 
> - **Header Checksum（头部校验和）**：用于检测头部错误。
> 
> - **Source IP Address（源IP地址）**：发送方的IP地址。
> 
> - **Destination IP Address（目的IP地址）**：接收方的IP地址。

#### **4. 分片的重组**

在目的地，接收端的IP层负责将所有片段重新组装成原始的完整数据包。重组过程包括：

1. **收集所有片段**：

    - 根据**Identification**字段，将属于同一个原始数据包的所有片段识别出来。

2. **根据片偏移排序**：

    - 使用**Fragment Offset**字段，将片段按正确的顺序排列。

3. **验证完整性**：

    - 检查是否所有片段都已收到。如果有片段丢失，整个数据包可能无法正确重组。
    - 检查每个片段的校验和，确保数据在传输过程中未被损坏。

4. **合并数据**：

    - 将所有片段的数据部分按照顺序拼接，恢复成原始的完整数据包。

> [!note]- 重组数据示例
> 假设有一个IPv4数据包，大小为4000字节，需要通过MTU为1500字节的网络链路传输：
> 
> 1. **原始数据包**：4000字节。
> 
> 2. **每个片段的最大数据部分**：1500字节 - 20字节（IP头部）= 1480字节。
> 
> 3. **分片**：
>  **第一个片段**：
>     - 数据部分：1480字节。
>     - 标志：MF = 1。
>     - 片偏移：0。
> 
>   **第二个片段**：
>     - 数据部分：1480字节。
>     - 标志：MF = 1。
>     - 片偏移：1480 / 8 = 185。
> 
>   **第三个片段**：
>     - 数据部分：1040字节（4000 - 1480 * 2）。
>     - 标志：MF = 0（最后一个片段）。
>     - 片偏移：2960 / 8 = 370。
>
> 4. **传输**：
> 
>     - 三个片段分别作为独立的IP数据包发送。
> 
> 5. **重组**：
> 
>     - 接收端根据标识符和片偏移，将三个片段按顺序拼接，恢复成原始的4000字节数据包。
#### **5. 分片的影响与优化**

**影响**：

- **性能下降**：分片会增加网络开销，因为每个片段都需要单独处理和传输，导致延迟增加。

- **错误风险增加**：如果任何一个片段在传输过程中丢失，整个数据包都需要重新传输，这降低了传输的效率和可靠性。

- **路由表复杂化**：分片信息需要在路由器之间传递，增加了路由器的处理负担。

**优化方法**：

1. **路径MTU发现（PMTUD，Path MTU Discovery）**：

    - 发送方通过探测网络路径上的最小MTU，动态调整数据包大小，避免分片。
    - 使用ICMP消息通知发送方如果数据包需要分片但设置了DF标志时，发送方可以调整数据包大小。

2. **合理配置MTU**：

    - 在网络设备上合理配置MTU值，尽量统一，以减少分片的可能性。

3. **使用较大的MTU（如Jumbo Frames）**：

    - 在支持的网络环境中，使用更大的MTU值（如9000字节的Jumbo Frames），减少分片的需求。

#### **总结**

分片是IP协议中用于处理大数据包传输的重要机制，通过将数据包拆分成更小的片段，确保数据能够在不同MTU限制的网络链路上顺利传输。然而，分片带来了额外的网络开销和复杂性，因此在网络设计和应用开发中，应尽量避免分片，通过路径MTU发现和合理的MTU配置等方法优化网络性能。

如果你在实际网络中观察和分析分片过程，可以使用**Wireshark**等网络分析工具捕获和查看分片后的IP数据包，进一步理解分片的工作原理和具体实现。