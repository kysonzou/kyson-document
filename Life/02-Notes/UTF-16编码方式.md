---
category:
- Tech
tags:
- Coding
status: Done
---



**UTF-16**是[Unicode](https://zh.wikipedia.org/wiki/Unicode "Unicode")[字符编码五层次模型](https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81#%E7%8E%B0%E4%BB%A3%E7%BC%96%E7%A0%81%E6%A8%A1%E5%9E%8B "字符编码")的第三层：字符编码表（Character Encoding Form，也称为"storage format"）的一种实现方式。即把Unicode字符集的抽象[码位](https://zh.wikipedia.org/wiki/%E7%A0%81%E4%BD%8D "码位")映射为16位长的整数（即[码元](https://zh.wikipedia.org/wiki/%E7%A0%81%E5%85%83 "码元")）的序列，用于数据存储或传递。Unicode字符的码位，需要1个或者2个16位长的码元来表示，因此这是一个变长表示。

UTF是"Unicode/UCS Transformation Format"的首字母缩写，即把Unicode字符转换为某種格式之意。UTF-16正式定義於[ISO/IEC 10646-1](https://zh.wikipedia.org/wiki/ISO_10646 "ISO 10646")的附錄C，而[RFC](https://zh.wikipedia.org/wiki/RFC "RFC")2781也定義了相似的做法。

## UTF-16描述

Unicode的编码空间从U+0000到U+10FFFF，共有1,112,064个码位（code point）可用来映射字符。Unicode的编码空间可以划分为17个平面（plane），每个平面包含216（65,536）个码位。17个平面的码位可表示为从U+xx0000到U+xxFFFF，其中xx表示十六进制值从0016到1016，共计17个平面。第一个平面称为**基本多语言平面**（Basic Multilingual Plane, **BMP**），或稱第零平面（Plane 0），其他平面称为**辅助平面**（Supplementary Planes）。基本多语言平面內，從U+D800到U+DFFF之間的码位區段是永久保留不映射到Unicode字符。UTF-16就利用保留下来的0xD800-0xDFFF区段的码位來對輔助平面的字符的码位進行編碼。

### 从U+0000至U+D7FF以及从U+E000至U+FFFF的码位

第一个Unicode平面（码位从U+0000至U+FFFF）包含了最常用的字符。该平面被称为基本多语言平面，缩写为_BMP_（Basic Multilingual Plane，BMP）。UTF-16与[UCS-2](https://zh.wikipedia.org/wiki/UCS-2 "UCS-2")编码这个范围内的码位为16比特长的单个码元，数值等价于对应的码位。BMP中的这些码位是仅有的可以在UCS-2中表示的码位。

### 从U+10000到U+10FFFF的码位

辅助平面（Supplementary Planes）中的码位，在UTF-16中被编码为**一对**16比特长的码元（即32位元，4字節），称作_代理对_（Surrogate Pair），具体方法是：

1. 码位减去 `0x10000`，得到的值的范围为20比特长的 `0...0xFFFFF`。
2. 高位的10比特的值（值的范围为 `0...0x3FF`）被加上 `0xD800` 得到第一个码元或称作高位代理（high surrogate），值的范围是 `0xD800...0xDBFF`。由于高位代理比低位代理的值要小，所以为了避免混淆使用，Unicode标准现在称高位代理为**前导代理**（lead surrogates）。
3. 低位的10比特的值（值的范围也是 `0...0x3FF`）被加上 `0xDC00` 得到第二个码元或称作低位代理（low surrogate），现在值的范围是 `0xDC00...0xDFFF`。由于低位代理比高位代理的值要大，所以为了避免混淆使用，Unicode标准现在称低位代理为**后尾代理**（trail surrogates）。

上述算法可理解为：辅助平面中的码位从U+10000到U+10FFFF，共计FFFFF个，即220=1,048,576个，需要20位来表示。如果用两个16位长的整数组成的序列来表示，第一个整数（称为前导代理）要容纳上述20位的前10位，第二个整数（称为后尾代理）容纳上述20位的后10位。还要能根据16位整数的值直接判明属于前导整数代理的值的范围（210=1024)，还是后尾整数代理的值的范围（也是210=1024）。因此，需要在基本多语言平面中保留不对应于Unicode字符的2048个码位，就足以容纳前导代理与后尾代理所需要的编码空间。这对于基本多语言平面总计65536个码位来说，仅占3.125%。

由于前导代理、后尾代理、BMP中的有效字符的码位，三者互不重叠，搜索是简单的：一个字符编码的一部分不可能与另一个字符编码的不同部分相重叠。这意味着UTF-16是自同步（self-synchronizing）的：可以通过仅检查一个码元来判定给定字符的下一个字符的起始码元。[UTF-8](https://zh.wikipedia.org/wiki/UTF-8 "UTF-8")也有类似优点，但许多早期的编码模式就不是这样，必须从头开始分析文本才能确定不同字符的码元的边界。

由于最常有的字符都在基本多文种平面中，许多软件处理代理对的部分往往得不到充分的测试。这导致了一些长期的bug与潜在安全漏洞，它们甚至存在于广为流行且评价颇高的应用软件中[1]。

### 从U+D800到U+DFFF的码位

Unicode标准规定U+D800...U+DFFF的值不对应于任何字符。

但是在使用UCS-2的时代，U+D800...U+DFFF内的值被占用，用于某些字符的映射。但只要不构成代理对，许多UTF-16编码解码还是能把这些不符合Unicode标准的字符映射正确的辨识、转换成合规的码元[2]。按照Unicode标准，这种码元序列本来应算作编码错误。

### 範例：

以U+10437编码（𐐷）为例:

1. `0x10437` 减去 `0x10000`，结果为`0x00437`，二进制为 `0000 0000 0100 0011 0111`
2. 分割它的上10位值和下10位值（使用二进制）：`0000 0000 01` 和 `00 0011 0111`
3. 添加 `0xD800` 到上值，以形成高位：`0xD800 + 0x0001 = 0xD801`
4. 添加 `0xDC00` 到下值，以形成低位：`0xDC00 + 0x0037 = 0xDC37`

- 下表总结了一起示例的转换过程，颜色指示码点位如何分布在所述的UTF-16中。由UTF-16编码过程中加入附加位的以黑色显示。

| 字符                                                                                              |           | 普通[二进制](https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%BF%9B%E5%88%B6 "二进制") | UTF-16[二进制](https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%BF%9B%E5%88%B6 "二进制") | UTF-16 [十六进制](https://zh.wikipedia.org/wiki/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6 "十六进制")  <br>字符代码 | UTF-16BE  <br>[十六进制](https://zh.wikipedia.org/wiki/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6 "十六进制")[字节](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82 "字节") | UTF-16LE  <br>[十六进制](https://zh.wikipedia.org/wiki/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6 "十六进制")[字节](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82 "字节") |
| ----------------------------------------------------------------------------------------------- | --------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [$](https://zh.wikipedia.org/wiki/$ "$")                                                        | `U+0024`  | `0000 0000 0010 0100`                                                    | `0000 0000 0010 0100`                                                        | `0024`                                                                                             | `00 24`                                                                                                                                                    | `24 00`                                                                                                                                                    |
| [€](https://zh.wikipedia.org/wiki/%E2%82%AC "€")                                                | `U+20AC`  | `0010 0000 1010 1100`                                                    | `0010 0000 1010 1100`                                                        | `20AC`                                                                                             | `20 AC`                                                                                                                                                    | `AC 20`                                                                                                                                                    |
| [𐐷](https://zh.wikipedia.org/w/index.php?title=%F0%90%90%8F&action=edit&redlink=1 "𐐏（页面不存在）") | `U+10437` | `0001 0000 0100 0011 0111`                                               | `1101 1000 0000 00011101 1100 0011 0111`                                     | `D801DC37`                                                                                         | `D8 01DC 37`                                                                                                                                               | `01 D837 DC`                                                                                                                                               |
| 𤭢                                                                                              | `U+24B62` | `0010 0100 1011 0110 0010`                                               | `1101 1000 0101 00101101 1111 0110 0010`                                     | `D852DF62`                                                                                         | `D8 52DF 62`                                                                                                                                               | `52 D862 DF`                                                                                                                                               |

## UTF-16的編碼模式

UTF-16的大尾序和小尾序儲存形式都在用。一般來說，以[Macintosh](https://zh.wikipedia.org/wiki/Macintosh "Macintosh")製作或儲存的文字使用大尾序格式，以[Microsoft](https://zh.wikipedia.org/wiki/Microsoft "Microsoft")或[Linux](https://zh.wikipedia.org/wiki/Linux "Linux")製作或儲存的文字使用小尾序格式。

為了弄清楚UTF-16文件的大小尾序，在UTF-16文件的開首，都會放置一個U+FEFF字符作為[Byte Order Mark](https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%85%83%E7%B5%84%E9%A0%86%E5%BA%8F%E8%A8%98%E8%99%9F "位元組順序記號")（UTF-16 LE以 `FF FE` 代表，UTF-16 BE以 `FE FF` 代表），以顯示這個文字檔案是以UTF-16編碼，其中U+FEFF字符在UNICODE中代表的意義是 `ZERO WIDTH NO-BREAK SPACE`，顧名思義，它是個沒有寬度也沒有斷字的空白。


## UTF-16與UCS-2的關係

UTF-16可看成是UCS-2的[父集](https://zh.wikipedia.org/wiki/%E7%88%B6%E9%9B%86 "父集")。在沒有[輔助平面字符](https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84 "Unicode字符平面映射")（surrogate code points）前，UTF-16與UCS-2所指的是同一的意思。但當引入輔助平面字符後，就稱為UTF-16了。現在若有軟件聲稱自己支援UCS-2編碼，那其實是暗指它不能支援在UTF-16中超過2位元組的字集。對於小於0x10000的UCS碼，UTF-16編碼就等於UCS碼。