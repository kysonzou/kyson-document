---
category:
  - Tech
tags:
  - TCPIP
status: Done
---
### 1. IP数据包

是IP协议用于在网络中传输数据的基本单位。在IP层，每个数据都被封装成一个数据包，通过网络设备进行传输。IP数据包包含了两部分：

1. **头部（Header）**：用于存储控制信息，为数据包的传输提供必要的指示。
2. **负载（Payload）**：实际传输的数据内容，通常是来自传输层（如TCP或UDP）的数据。

### 2. IPv4数据包头部

 IP数据包头部的各个字段对数据包的传输和处理起着至关重要的作用。以下是IP头部主要字段的作用说明：

**1. 版本（Version）**

- 作用：标识IP协议的版本。IPv4头部的值为4，IPv6头部的值为6。
- 用途：帮助设备识别使用的IP协议版本，从而进行相应的处理。

**2. 头部长度（IHL - Internet Header Length）**

- 作用：指定IP头部的长度，以4字节（32位）为单位，值范围为5到15。
- 用途：确定数据包中实际负载的位置。头部长度的值如果是5，则头部长度为20字节（IPv4最小值）。大于20字节的情况表示头部包含选项字段。

**3. 服务类型（Type of Service - ToS）**

- 作用：用于定义数据包的优先级和服务质量（QoS）要求。
- 用途：帮助路由器和交换机在不同的数据包间分配优先级，高优先级的包可以优先传输，用于实时性要求高的应用（如语音和视频流）。

**4. 总长度（Total Length）**

- 作用：表示整个IP数据包（包括头部和数据）的总长度，单位为字节，最大为65,535字节。
- 用途：帮助接收端判断数据包的完整性和数据长度，确保数据完整接收。

**5. 标识符（Identification）**

- 作用：分配一个唯一的标识符，标识单个数据包，特别是用于分片的数据包。
- 用途：接收端利用标识符将分片的数据包正确重组为完整的数据包。

**6. 标志（Flags）**

- 作用：包含3个比特的标志字段，用于控制分片行为。

    - **第1位**：未使用，保留位。
    - **第2位（DF位）**：Don’t Fragment，不分片标志。值为1时表示不允许分片。
    - **第3位（MF位）**：More Fragments，更多分片标志。值为1表示后续还有分片，值为0表示该片是最后一个分片。
- 用途：帮助路由器和接收端正确处理分片，尤其在分片时识别数据包是否完整。

**7. 片偏移（Fragment Offset）**

- 作用：表示该分片在原始数据包中的相对位置，单位为8字节。
- 用途：帮助接收端将分片按正确顺序重组为原始数据包。

**8. 生存时间（TTL - Time to Live）**

- 作用：数据包的“生存时间”，表示数据包在网络中的最大跳数，每经过一个路由器TTL减1，TTL为0时数据包被丢弃。
- 用途：防止数据包在网络中无限循环，保护网络资源，避免路由环路。

**9. 协议（Protocol）**

- 作用：表示数据包负载所使用的上层协议（如TCP为6，UDP为17）。
- 用途：帮助IP层识别数据包的上层协议类型，以便正确传递到相应的传输层协议处理。

**10. 校验和（Header Checksum）**

- 作用：用于验证IP头部数据的完整性，确保数据包头部在传输过程中没有损坏。
- 用途：在每一跳计算校验和并验证，若校验和不匹配，则丢弃数据包，从而保障数据的准确性。
- ==**IPv6头部没有校验和字段**，因为IPv6认为在链路层、传输层已经有足够的校验手段，这样设计可以简化处理，减少计算开销。==

**11. 源地址（Source IP Address）**

- 作用：数据包发送方的IP地址。
- 用途：接收方通过源地址知道数据来自何处，并且可以根据该地址回复。

**12. 目的地址（Destination IP Address）**

- 作用：数据包的接收方IP地址。
- 用途：路由器和交换机根据目的地址将数据包转发到正确的目标设备。

**13. 选项（Options）**

- 作用：可选字段，提供额外的控制和调试信息，增加头部灵活性。
- 用途：主要用于实验性或特殊用途，如安全选项、时间戳等。一般不常用，且会增加头部长度。

**14. 填充（Padding）**

- 作用：用于确保头部长度为32位的倍数，以便IP头部对齐。
- 用途：填充字段仅在选项字段存在时使用，避免数据包头部出现数据偏移，保证数据包在处理时符合标准格式。

### 3. IPv4数据包头部字段大小

**IP头部的字段顺序**是固定的，尤其是在IPv4和IPv6协议中。每种协议标准都规定了头部字段的顺序，确保数据包的接收方能够正确解析并处理这些字段。接收方根据预定义的顺序逐个字段地读取头部信息，而不需要重新排序字段。

IPv4的头部结构包括多个固定字段，这些字段有严格的顺序，确保每个字段的含义和大小都得到正确解析。以下是IPv4头部的字段顺序：

| **字段名称**                        | **大小** | **说明**             |
| ------------------------------- | ------ | ------------------ |
| **版本（Version）**                 | 4 位    | 指定IP协议版本（IPv4为4）。  |
| **IHL（Internet Header Length）** | 4 位    | IP头部长度，单位为4字节。     |
| **类型字段（Type of Service, ToS）**  | 8 位    | 表示服务质量（QoS）的控制。    |
| **总长度（Total Length）**           | 16 位   | 包括头部和数据的总长度。       |
| **标识（Identification）**          | 16 位   | 用于标识数据包。           |
| **标志（Flags）**                   | 3 位    | 用于控制数据包的分段。        |
| **片偏移（Fragment Offset）**        | 13 位   | 数据包分段时的数据偏移量。      |
| **TTL（Time to Live）**           | 8 位    | 控制数据包的生命周期（跳数）。    |
| **协议（Protocol）**                | 8 位    | 标识上层协议（如TCP、UDP等）。 |
| **头部校验和（Header Checksum）**      | 16 位   | 用于检验IP头部的完整性。      |
| **源IP地址（Source Address）**       | 32 位   | 数据包的源地址。           |
| **目标IP地址（Destination Address）** | 32 位   | 数据包的目标地址。          |
| **选项（Options）**                 | 可变     | 可选字段，不是每个数据包都有。    |
| **填充（Padding）**                 | 可变     | 保证选项部分的长度为32位的倍数。  |

可以看到，IPv4头部的字段顺序是固定的，字段的顺序决定了接收方如何逐一解析各个字段。即使存在 **选项字段**（在某些情况下），也会按规定位置插入，但其他字段顺序不变。


**为什么字段顺序固定**

字段顺序是固定的，主要是为了：

 - **标准化**：让网络中的所有设备和协议都能按照相同的规则解析IP数据包。

- **高效解析**：接收方只需按固定顺序读取字段，确保高效的处理和数据包转发。

- **兼容性**：所有实现IPv4或IPv6协议的设备都能够一致地处理数据包，避免解析错误或混淆。
