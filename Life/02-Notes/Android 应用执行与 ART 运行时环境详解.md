---
category:
  - Knowledge
tags: 
status: Done
---
### I. Android 应用开发与执行概览

1. **主流开发语言**：Kotlin, Java。应用逻辑主要用这些语言编写。
2. **编译流程 (主流)**：源代码 (Kotlin/Java) -> JVM 字节码 -> **DEX (Dalvik Executable) 字节码**。DEX 是 Android 平台特有的、优化的字节码格式。
3. **原生代码支持 (NDK)**：
    - Android **支持**直接执行 C/C++ 编译的原生机器码。
    - 通过 **NDK (Native Development Kit)**，开发者可以将 C/C++ 代码编译成特定 CPU 架构（如 arm64-v8a, armeabi-v7a）的共享库 (`.so` 文件)。
    - 这些 `.so` 文件打包在 APK 中，由操作系统加载，CPU 直接执行其机器码。
    - 常用于性能敏感场景（游戏、媒体处理）或复用 C/C++ 库，通常通过 **JNI (Java Native Interface)** 从 Java/Kotlin 代码调用。

### II. Android 运行时 (ART): 核心角色与演进

1. **历史演进**：
    - **早期 (Android 4.4 及之前)**：使用 **Dalvik 虚拟机 (DVM)**，主要通过**解释执行** DEX 字节码，并辅以 **JIT (Just-In-Time)** 编译来优化热点代码。
    - **当前 (Android 5.0 及之后)**：使用 **ART (Android Runtime)**，成为标准的运行时环境。
2. **核心目标**：高效、可靠地执行应用的 DEX 字节码，并作为关键层来**适配和抽象** Android 生态中极其**多样化的硬件**。

### III. ART 工作原理：如何适配多样化硬件

1. **AOT (Ahead-of-Time) 编译 - 主要策略**：
    - **时机与地点**：在应用**安装到用户设备时**或设备空闲时进行。
    - **过程**：ART 内的 `dex2oat` 工具读取通用的 DEX 字节码，并将其**编译成针对当前设备特定 CPU 架构的原生机器码**。
    - **设备感知**：ART 知道当前设备的 CPU 指令集（如 ARMv7, ARMv8-A 64 位等）。
    - **结果**：生成针对性优化过的本地代码 (`.oat` 文件)，使得应用运行时主要执行的是高效的原生指令，而非解释字节码。
    - **适配方式**：通过**在每个设备上进行本地化编译**，将同一份 DEX 字节码适配到不同的 CPU 硬件上。
2. **JIT (Just-In-Time) 编译 - 辅助策略**：
    - ART 仍然保留 JIT 编译器。
    - 可在运行时基于程序实际运行情况 (Profile-Guided Optimization - PGO) 对代码进行**动态优化和重新编译**，进一步提升性能。
3. **解释执行**：作为后备机制，用于执行未被 AOT/JIT 编译的代码。

### IV. “ART 环境”的概念：不仅仅是编译器

“ART 环境”是指 Android 系统上负责管理和执行应用代码（DEX 及生成的原生码）的**整个托管运行时系统**，包含：

1. **代码执行引擎**：AOT 编译器 (`dex2oat`)、JIT 编译器、解释器。
2. **核心运行时服务**：
    - **自动内存管理 (垃圾回收 - GC)**：管理 Java/Kotlin 对象的内存分配与回收。
    - **线程管理**：支持应用创建和管理线程（语言层面）。
    - **异常处理**：捕获和处理 Java/Kotlin 异常。
    - **类加载**：按需加载类定义。
    - **JNI 实现**：提供 Java/Kotlin 与 C/C++ 代码交互的桥梁。
    - **调试与性能分析支持**。
3. **与核心库的集成**：紧密配合 Android 的核心 Java 库，支撑应用功能。

### V. ART 与 Android OS 的关系：分工与协作

1. **职责区分**：
    - **Android OS (Kernel + Native Frameworks)**：负责底层、通用的操作系统任务（进程管理、低级内存管理、驱动、文件系统、网络、系统调用、权限等），为**所有**程序提供基础平台和硬件接口。
    - **ART**：专注于**运行和管理托管语言 (Java/Kotlin) 应用**，提供语言特定的运行时服务（GC 等），并完成**应用代码到具体 CPU 指令集的适配翻译**。
2. **为何分层**：
    - **模块化与独立演进**：OS 内核和 ART 可以相对独立地更新发展。
    - **通用性与灵活性**：OS 需支持原生进程，不应与特定语言运行时（如 ART）深度绑定。
    - **清晰的抽象层次**：OS 抽象物理硬件；ART 抽象 CPU 指令集并提供托管语言环境。
3. **协作关系**：ART 运行在 Android OS 之上，**使用** OS 提供的底层服务（如内存分配请求、线程创建、系统调用），并在此基础上构建其托管环境。
4. **核心观点**：ART 不是取代 OS 的职能，而是**增加了一个专门服务于 Java/Kotlin 应用的中间管理和抽象层**，其一个关键任务是解决硬件（CPU）多样性带来的应用适配问题。
